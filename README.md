# 电力用户窃电检测与定位装置开发与应用
## 项目主要介绍：
### 项目简介：
    设计了一套基于STM32电能数据采集装置并实现了电能数据的采集、上报以及控制指令的接收，在小程序上对设备进行管理及窃电结果的显示，利用IMX6ULL硬件平台下开发了一套数据查询可视化系统。
### 主要职责：
    1.硬件电路的设计与测试，利用嘉立创EDA绘制采集装置硬件原理图及PCB，并打板测试。
    2.采集装置功能实现，在KEIL下采用C语言编程，负责采集芯片BL0910与STM32的SPI通信以及电能数据的采集；负责EC200U 4G通信模块的驱动，通过串口下发AT指令，实现EC200U的激活、注册以及连网，实现电能数据的上传以及控制指令的接收。
    3.嵌入式数据可视化显示系统的实现，在Qt Creator开发工具下，采用C++语言编程，集成了用户登录、订阅MQTT话题、数据库查询以及数据显示等功能；同时利用交叉编译链进行编译，在IMX6ULL硬件平台上运行。
### 项目成果：
    电力数据测量误差小于1%，测试阶段累计为公司发现窃电用户约50户，累计挽回损失约10万元。
### 详细介绍
    《电力用户窃电检测与定位装置开发与应用》项目是安徽百舸争流信息科技有限公司委托实验室的一个窃电检测项目，用于检测电力用户是否存在偷电漏电行为，主要采集电流、电压、功率、频率等电力数据，对这些数据进行进一步分析，得到窃电检测结果并写入移动端。整个项目电力数据采集误差小于1%，项目测试阶段累计为公司发现窃电用户约50户，累计挽回损失约10万元。现已交付公司稳定运行。整个项目具体可以细分为采集端、云服务器端、移动端、边缘显示端。
    1.采集端：设计了一个以STM32F103C8T6为主控芯片的电能数据采集装置，自己绘制原理图和PCB并打板测试，通过BL0910芯片以及电流互感器对各节点的电能数据进行采集，数据采集芯片利用SPI协议与STM32进行通信，然后STM32利用EC200U模块通过MQTT协议进行数据的上报。
    2.云服务器端：云服务器端主要是利用阿里云ECS服务器和阿里云物联网平台，采集端将数据上报至物联网平台，物联网平台进行数据转发将采集端的数据入库、存储，方便后期数据的处理和历史数据的查看，利用云服务器的计算能力进行窃电算法的运行，设计了一个后台管理系统，用于移动端用户的授权与管理及设备安装管理。
    3.边缘显示端：设计了一个以IMX6ULL为主控芯片的数据显示装置，利用QT开发框架开发了一套显示系统，通过订阅MQTT话题或者连接mysql数据库的形式可以查看任意一台采集设备的电能数据，同时也可以远程控制任意一台采集设备。
    4.移动端：设计了一个微信小程序，实现以下功能：采集设备的安装与管理、采集设备的远程控制、采集设备的数据查看以及窃电检测结果的查看。(1)采集设备的安装与管理：在对设备进行安装时，利用后台管理系统授权的二维码进行扫码安装，同时可以选择设备安装的位置，安装后的设备可以在微信小程序以及后台管理系统的地图上查看位置。(2)采集设备的远程控制：利用微信小程序可以控制采集设备的报警，方便寻找设备。(3)采集设备的数据查看：移动端小程序可以查看该用户下安装设备的所有数据。(4)窃电检测结果的查看：边缘设备将窃电检测的结果上传到云服务器，移动端小程序获取云服务器的窃电检测结果进行显示。
    这个项目在交付后，在原有版本的基础上，修改了采集芯片，将采集芯片BL0910换成了RN8302，将EC200U模块换成了BC20，做了一定修改完善之后，将采集的数据范围继续扩大，修改后可采集电流、电压、有功功率、无功频率、视在功率、功率因数、有功电量。同时，将阿里云物联网平台换成EMQX开源MQTT服务器，自己利用阿里云服务器搭建了物联网平台，用于实验室内部科研采集数据使用，数据采集误差小于1%。
## 一.采集端

### 版本一

#### stm32芯片型号
    stm32f103c8t6
#### 采集芯片
    型号：BL0910
    通信协议：SPI协议
#### 原理图及PCB
    文件名：8路测量-c8t6 V3.1.eprj
    绘制软件：立创eda专业版
#### 采集数据类型
    电流、电压、频率
#### 4G通信模块
    移远EC200U
#### 服务器
    阿里云ECS + 阿里云物联网平台
#### 工程文件
    MQTT_HAL_BL0910
    采用BL0910作为采集芯片，采集8路电流、电压信息，用作窃电行为判别数据支持，采用阿里云物联网平台对接EC200U设备，上传服务器。

### 版本二
#### stm32芯片型号
    stm32f103c8t6
#### 采集芯片
    型号：RN8302
    通信协议：SPI协议
#### 原理图及PCB
    文件：BC20+RN8302.eprj
    绘制软件：立创eda专业版
#### 采集数据类型
    电流、电压、频率、有功功率、无功功率、电能
#### 4G通信模块
    移远BC20
#### 服务器
    阿里云ECS + EMQX
#### 工程文件
    BC20+EMQX+RN8302(裸机)/FreeRtos+BC20+EMQX+RN8302(带FreeRTos操作系统)
    采用RN8302作为采集芯片，采集三相电流、电压、频率、有功功率、无功功率、电量等参数，用作窃电行为判别，同时作为实验室内部采集数据使用
## 二.显示端
    electricty-theft：嵌入式显示端用于显示采集端上传的数据，通过连接到EMQX服务器或者阿里云服务器， 采用基于IMX6ULL的硬件平台，采用Qt框架采用c++进行开发。
    功能：
        1.订阅话题的形式获取数据并解析JSON数据，并以文本的形式和曲线的形式进行显示。
        2.连接数据库，并根据设备客户端id查询数据，并进行显示
        3.连接wifi，实现无线连接。
    使用方法：
        Qt Creator打开编译之后将编译后的可执行文件拷贝至硬件平台运行即可。
    注意事项：
        1.软键盘的使用，将electricty-theft中的dict整个文件夹拷贝至可执行文件的同目录，将libSoft-keyboard.so拷贝至qt安装目录下plugins/platforminputcontexts即可
        我的对应的是/usr/lib/plugins/platforminputcontexts。
        2.连接wifi的脚本alientek_usb_wifi_setup.sh根据自己的实际情况进行修改，我的与可执行目录在同一目录。
        
        
   
    
    
